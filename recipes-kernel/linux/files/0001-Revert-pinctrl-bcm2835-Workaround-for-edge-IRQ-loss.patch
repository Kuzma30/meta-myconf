From 521813d51f8f86b2eb54068f3db9f2fc9901fd51 Mon Sep 17 00:00:00 2001
From: Kuzemko Alexandr <kuzemkoa@gmail.com>
Date: Sun, 14 May 2023 14:14:51 +0300
Subject: [PATCH] Revert "pinctrl: bcm2835: Workaround for edge IRQ loss"

This reverts commit 0c39d90729ed75c7112cf9aeb9094dc82fe308c6.
---
 drivers/pinctrl/bcm/pinctrl-bcm2835.c | 23 +++++------------------
 1 file changed, 5 insertions(+), 18 deletions(-)

diff --git a/drivers/pinctrl/bcm/pinctrl-bcm2835.c b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
index 3c5d72acb346..d9758d1d3b84 100644
--- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
@@ -422,32 +422,15 @@ static void bcm2835_gpio_irq_handle_bank(struct bcm2835_pinctrl *pc,
 	unsigned long events;
 	unsigned offset;
 	unsigned gpio;
-	u32 levs, levs2;
 
 	events = bcm2835_gpio_rd(pc, GPEDS0 + bank * 4);
-	levs = bcm2835_gpio_rd(pc, GPLEV0 + bank * 4);
 	events &= mask;
 	events &= pc->enabled_irq_map[bank];
-	bcm2835_gpio_wr(pc, GPEDS0 + bank * 4, events);
-
-retry:
 	for_each_set_bit(offset, &events, 32) {
 		gpio = (32 * bank) + offset;
 		generic_handle_domain_irq(pc->gpio_chip.irq.domain,
 					  gpio);
 	}
-	events = bcm2835_gpio_rd(pc, GPEDS0 + bank * 4);
-	levs2 = bcm2835_gpio_rd(pc, GPLEV0 + bank * 4);
-
-	events |= levs2 & ~levs & bcm2835_gpio_rd(pc, GPREN0 + bank * 4);
-	events |= ~levs2 & levs & bcm2835_gpio_rd(pc, GPFEN0 + bank * 4);
-	events &= mask;
-	events &= pc->enabled_irq_map[bank];
-	if (events) {
-		bcm2835_gpio_wr(pc, GPEDS0 + bank * 4, events);
-		levs = levs2;
-		goto retry;
-	}
 }
 
 static void bcm2835_gpio_irq_handler(struct irq_desc *desc)
@@ -687,7 +670,11 @@ static int bcm2835_gpio_irq_set_type(struct irq_data *data, unsigned int type)
 
 static void bcm2835_gpio_irq_ack(struct irq_data *data)
 {
-	/* Nothing to do - the main interrupt handler includes the ACK */
+	struct gpio_chip *chip = irq_data_get_irq_chip_data(data);
+	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
+	unsigned gpio = irqd_to_hwirq(data);
+
+	bcm2835_gpio_set_bit(pc, GPEDS0, gpio);
 }
 
 static int bcm2835_gpio_irq_set_wake(struct irq_data *data, unsigned int on)
-- 
2.34.1

